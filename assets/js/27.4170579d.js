(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{515:function(s,t,a){"use strict";a.r(t);var e=a(20),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"使用docker部署mysql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用docker部署mysql"}},[s._v("#")]),s._v(" 使用Docker部署mysql")]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#启动服务"}},[s._v("启动服务")]),a("ul",[a("li",[a("a",{attrs:{href:"#docker-run"}},[s._v("docker run")])]),a("li",[a("a",{attrs:{href:"#连接mysql"}},[s._v("连接mysql")])]),a("li",[a("a",{attrs:{href:"#docker-compose-yml"}},[s._v("docker-compose.yml")]),a("ul",[a("li",[a("a",{attrs:{href:"#环境变量说明"}},[s._v("环境变量说明")])])])])])]),a("li",[a("a",{attrs:{href:"#使用自定义的配置文件"}},[s._v("使用自定义的配置文件")])]),a("li",[a("a",{attrs:{href:"#不使用-cnf-文件进行配置"}},[s._v("不使用cnf文件进行配置")])]),a("li",[a("a",{attrs:{href:"#docker秘钥"}},[s._v("Docker秘钥")]),a("ul",[a("li",[a("a",{attrs:{href:"#defining-and-using-secrets-in-compose-files-https-docs-docker-com-engine-swarm-secrets-defining-and-using-secrets-in-compose-files"}},[s._v("Defining and using secrets in compose files")]),a("ul",[a("li",[a("a",{attrs:{href:"#使用"}},[s._v("使用")])])])])])]),a("li",[a("a",{attrs:{href:"#初始化实例"}},[s._v("初始化实例")])]),a("li",[a("a",{attrs:{href:"#注意事项"}},[s._v("注意事项")]),a("ul",[a("li",[a("a",{attrs:{href:"#存储数据"}},[s._v("存储数据")])]),a("li",[a("a",{attrs:{href:"#针对已经存在的数据库"}},[s._v("针对已经存在的数据库")])]),a("li",[a("a",{attrs:{href:"#以任意用户身份运行"}},[s._v("以任意用户身份运行")])]),a("li",[a("a",{attrs:{href:"#创建数据库备份"}},[s._v("创建数据库备份")])]),a("li",[a("a",{attrs:{href:"#从数据库备份中恢复数据"}},[s._v("从数据库备份中恢复数据")])])])]),a("li",[a("a",{attrs:{href:"#参考"}},[s._v("参考")])]),a("li",[a("a",{attrs:{href:"#错误"}},[s._v("错误")]),a("ul",[a("li",[a("a",{attrs:{href:"#failed-to-access-directory-for-secure-file-priv-please-make-sure-that-directory-exists-and-is-accessible-by-mysql-server-supplied-value-var-lib-mysql-files"}},[s._v("Failed to access directory for --secure-file-priv. Please make sure that directory exists and is accessible by MySQL Server. Supplied value : /var/lib/mysql-files")])]),a("li",[a("a",{attrs:{href:"#启动容器后-无法登录mysql"}},[s._v("启动容器后，无法登录mysql")]),a("ul",[a("li",[a("a",{attrs:{href:"#问题出现原因"}},[s._v("问题出现原因")])]),a("li",[a("a",{attrs:{href:"#解决方法"}},[s._v("解决方法")])])])]),a("li",[a("a",{attrs:{href:"#docker-compose-down-或-docker-compose-stop后-再此启动-则无法访问-message-from-server-host-192-168-224-4-is-not-allowed-to-connect-to-this-mysql-server"}},[s._v("docker-compose down 或 docker-compose stop后，再此启动，则无法访问“message from server: \"Host '192.168.224.4' is not allowed to connect to this MySQL server\"“")])]),a("li",[a("a",{attrs:{href:"#如何在启动mysql时-自动导入数据库"}},[s._v("如何在启动mysql时，自动导入数据库")]),a("ul",[a("li",[a("a",{attrs:{href:"#initializing-a-fresh-instance"}},[s._v("Initializing a fresh instance")])])])]),a("li",[a("a",{attrs:{href:"#存在远程访问权限的问题"}},[s._v("存在远程访问权限的问题:")])])])])])]),a("p"),s._v(" "),a("h2",{attrs:{id:"启动服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动服务"}},[s._v("#")]),s._v(" 启动服务")]),s._v(" "),a("h3",{attrs:{id:"docker-run"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-run"}},[s._v("#")]),s._v(" docker run")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker run --name some-mysql -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-secret-pw -d mysql:tag\n")])])]),a("ul",[a("li",[s._v("my-secret-pw 是 root 用户的密码")])]),s._v(" "),a("h3",{attrs:{id:"连接mysql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#连接mysql"}},[s._v("#")]),s._v(" 连接mysql")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("docker run -it --network some-network --rm mysql mysql -h some-mysql -uexample-user -p\n")])])]),a("ul",[a("li",[s._v("some-mysql 是你刚刚启动的容器的名称")]),s._v(" "),a("li",[s._v("some-network 是 Docker network")])]),s._v(" "),a("p",[s._v("此命令也可以连接非Docker启动的mysql")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker run -it --rm mysql mysql -h some.mysql.host -usome-mysql-user -p\n")])])]),a("h3",{attrs:{id:"docker-compose-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-yml"}},[s._v("#")]),s._v(" docker-compose.yml")]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3.9"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ma"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("authentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plugin=mysql_native_password\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ma"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("context")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dockerfile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Dockerfile\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 3306"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_ROOT_HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_DATABASE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" style_app\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ~/style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ma/dev/mysql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/lib/mysql\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ma\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("adminer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" adminer\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ma"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("adminer\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 9999"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n      \n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("style-ma")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("driver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bridge\n   \n")])])]),a("h4",{attrs:{id:"环境变量说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境变量说明"}},[s._v("#")]),s._v(" 环境变量说明")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("MYSQL_ROOT_PASSWORD")]),s._v(": 此环境变量是强制的，指定的密码会被设置为 "),a("code",[s._v("root")]),s._v(" 超级账户的密码。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("MYSQL_DATABASE")]),s._v("(可选): 指定在镜像启动后要创建的数据库名称。如果同时指定了用户名和密码，这个用户会被授予此数据库的超级用户权限（对应于"),a("code",[s._v("GRANT ALL")]),s._v("）")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("MYSQL_USER")]),s._v("(可选),"),a("code",[s._v("MYSQL_PASSWORD")]),s._v("(可选): 创建一个新的用户并设置该用户的密码。此用户会被赋予"),a("code",[s._v("MYSQL_DATABASE")]),s._v("所指定的数据库的超级用户权限。要创建一个用户，这两个环境变量都需要设置")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("MYSQL_ALLOW_EMPTY_PASSWORD")]),s._v("(可选): 设置非空值，如 "),a("code",[s._v("yes")]),s._v("，允许root用户不用密码启动容器。注意: 不建议设置此环境变量为"),a("code",[s._v("yes")]),s._v("，除非你直到你在做什么，因为此操作会让你的数据库完全不受保护，任何人都可以获取超级用户访问权限。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("MYSQL_RANDOM_ROOT_PASSWORD")]),s._v("(可选): 设置非空值，如"),a("code",[s._v("yes")]),s._v("，为root用户生成一个随机的初始密码(使用"),a("code",[s._v("pwgen")]),s._v(")。生成的密码会在stdout中打印("),a("code",[s._v("GENERATED ROOT PASSWORD: .....")]),s._v(")")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("MYSQL_ONETIME_PASSWORD")]),s._v("(可选): 设置root用户(不是在"),a("code",[s._v("MYSQL_USER")]),s._v("中指定的用户)在初始完成后即过期，在第一次登录时强制修改密码。任意非空值都会激活此配置。注意: 此功能只支持MySQL 5.6+版本。在MySQL 5.5上使用此功能会在初始化时报错。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("MYSQL_INITDB_SKIP_TZINFO")]),s._v(": 默认情况下，entrypoint脚本自动加载 "),a("code",[s._v("CONVERT_TZ()")]),s._v("函数所需要的时区数据。如果不需要，任意非空值会禁用时区加载。")])])]),s._v(" "),a("p",[s._v("./db/Dockerfile:")]),s._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" mysql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("8.0\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" style_app.sql /docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("entrypoint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("initdb.d\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3306\n")])])]),a("h2",{attrs:{id:"使用自定义的配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用自定义的配置文件"}},[s._v("#")]),s._v(" 使用自定义的配置文件")]),s._v(" "),a("p",[s._v("例如，自定义配置文件位置为"),a("code",[s._v("/my/custom/config-file.cnf")]),s._v("，挂载配置文件 "),a("code",[s._v("/my/custom:/etc/mysql/conf.d")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker run --name some-mysql -v /my/custom:/etc/mysql/conf.d -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-secret-pw -d mysql:tag\n")])])]),a("p",[s._v("mysql运行时会使用 "),a("code",[s._v("/etc/mysql/my.cnf")]),s._v("  和 "),a("code",[s._v("/etc/mysql/conf.d/config-file.cnf")]),s._v(" 中的配置（后面的优先级高)")]),s._v(" "),a("h2",{attrs:{id:"不使用cnf文件进行配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不使用cnf文件进行配置"}},[s._v("#")]),s._v(" 不使用"),a("code",[s._v("cnf")]),s._v("文件进行配置")]),s._v(" "),a("p",[s._v("大多配置可以作为参数传递给 "),a("code",[s._v("mysqld")]),s._v("。 如:  设置mysql server 的字符集:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker run --name some-mysql -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-secret-pw -d mysql:tag --character-set-server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4 --collation-server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4_unicode_ci\n")])])]),a("p",[s._v("如果要查看所有可用的配置项，可以运行:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker run -it --rm mysql:tag --verbose --help\n")])])]),a("h2",{attrs:{id:"docker秘钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker秘钥"}},[s._v("#")]),s._v(" Docker秘钥")]),s._v(" "),a("p",[s._v("除了使用环境变量传递敏感信息外，还可以在上面列出的环境变量后面追加"),a("code",[s._v("_FILE")]),s._v("，让初始化脚本从容器的文件中加载这些变量。特别的，这中方式可以用于从存储在 "),a("code",[s._v("/run/secrets/<secret_name>")]),s._v(" 文件中的Docker秘钥加载密码。例如:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("docker run --name some-mysql -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/run/secrets/mysql-root -d mysql:tag\n")])])]),a("p",[s._v("当前这种方式只支持: "),a("code",[s._v("MYSQL_ROOT_PASSWORD")]),s._v(", "),a("code",[s._v("MYSQL_ROOT_HOST")]),s._v(", "),a("code",[s._v("MYSQL_DATABASE")]),s._v(", "),a("code",[s._v("MYSQL_USER")]),s._v(", and "),a("code",[s._v("MYSQL_PASSWORD")]),s._v(".")]),s._v(" "),a("blockquote",[a("p",[s._v("Docker secrets 是什么?")]),s._v(" "),a("p",[s._v("https://docs.docker.com/engine/reference/commandline/secret/")]),s._v(" "),a("p",[s._v("https://docs.docker.com/engine/swarm/secrets/")]),s._v(" "),a("h3",{attrs:{id:"defining-and-using-secrets-in-compose-files"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#defining-and-using-secrets-in-compose-files"}},[s._v("#")]),s._v(" "),a("a",{attrs:{href:"https://docs.docker.com/engine/swarm/secrets/#defining-and-using-secrets-in-compose-files",target:"_blank",rel:"noopener noreferrer"}},[s._v("Defining and using secrets in compose files"),a("OutboundLink")],1)])]),s._v(" "),a("h4",{attrs:{id:"使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[s._v("#")]),s._v(" 使用")]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v(".\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mysql_root\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_ROOT_PASSWORD_FILE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /run/secrets/mysql_root\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secrets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql_root")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ~/todolist/dev/mysql/conf/mysql_root\n")])])]),a("h2",{attrs:{id:"初始化实例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化实例"}},[s._v("#")]),s._v(" 初始化实例")]),s._v(" "),a("p",[s._v("容器首次启动后，会根据提供的数据库名创建一个新的数据库。此外，它会执行``/docker-entrypoint-initdb.d"),a("code",[s._v("中的")]),s._v(".sh"),a("code",[s._v("，")]),s._v(".sql"),a("code",[s._v("和")]),s._v(".sql.gz`文件。 这些文件会按照字母顺序执行。")]),s._v(" "),a("h2",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[s._v("#")]),s._v(" 注意事项")]),s._v(" "),a("h3",{attrs:{id:"存储数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储数据"}},[s._v("#")]),s._v(" 存储数据")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("创建数据存储目录 "),a("code",[s._v("/my/own/datadir")])])]),s._v(" "),a("li",[a("p",[s._v("挂载目录到 "),a("code",[s._v("/var/lib/mysql")])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker run --name some-mysql -v /my/own/datadir:/var/lib/mysql -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-secret-pw -d mysql:tag\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"针对已经存在的数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#针对已经存在的数据库"}},[s._v("#")]),s._v(" 针对已经存在的数据库")]),s._v(" "),a("p",[s._v("如果关在的数据目录中已经有一个数据库了，那么 "),a("code",[s._v("MYSQL_ROOT_PASSWORD")]),s._v("变量会被忽略，已存在的数据库不会有任何改变。")]),s._v(" "),a("h3",{attrs:{id:"以任意用户身份运行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#以任意用户身份运行"}},[s._v("#")]),s._v(" 以任意用户身份运行")]),s._v(" "),a("p",[s._v("使用 --user 设置以哪个用户运行（除了"),a("code",[s._v("root/0")]),s._v("）。例如:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" data\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -lnd data\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":54 data\n$ docker run -v "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PWD")]),s._v('/data"')]),s._v(":/var/lib/mysql --user "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(":1000 --name some-mysql -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-secret-pw -d mysql:tag\n")])])]),a("h3",{attrs:{id:"创建数据库备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建数据库备份"}},[s._v("#")]),s._v(" 创建数据库备份")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("docker exec")]),s._v("来运行工具。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" some-mysql "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" -c "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exec mysqldump --all-databases -u root -p\""),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MYSQL_ROOT_PASSWORD")]),s._v("\"'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /some/path/on/your/host/all-databases.sql\n")])])]),a("h3",{attrs:{id:"从数据库备份中恢复数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从数据库备份中恢复数据"}},[s._v("#")]),s._v(" 从数据库备份中恢复数据")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -i some-mysql "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" -c "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exec mysql -u root -p\""),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MYSQL_ROOT_PASSWORD")]),s._v("\"'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" /some/path/on/your/host/all-databases.sql\n")])])]),a("p",[s._v("上面的命令无效，会报Access Denied错误。可以使用下面的命令:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -i todolist-mysql-test mysql -u root --password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("database"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" ~/xxxx.sql\n")])])]),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),a("p",[s._v("翻译自: https://hub.docker.com/_/mysql")]),s._v(" "),a("h2",{attrs:{id:"错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#错误"}},[s._v("#")]),s._v(" 错误")]),s._v(" "),a("h3",{attrs:{id:"failed-to-access-directory-for-secure-file-priv-please-make-sure-that-directory-exists-and-is-accessible-by-mysql-server-supplied-value-var-lib-mysql-files"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#failed-to-access-directory-for-secure-file-priv-please-make-sure-that-directory-exists-and-is-accessible-by-mysql-server-supplied-value-var-lib-mysql-files"}},[s._v("#")]),s._v(" Failed to access directory for --secure-file-priv. Please make sure that directory exists and is accessible by MySQL Server. Supplied value : /var/lib/mysql-files")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("style-ma-db | 2021-01-11 06:47:41+00:00 [Note] [Entrypoint]: Switching to dedicated user 'mysql'\nstyle-ma-db | 2021-01-11 06:47:41+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.22-1debian10 started.\nstyle-ma-db | mysqld: Error on realpath() on '/var/lib/mysql-files' (Error 2 - No such file or directory)\nstyle-ma-db | 2021-01-11T06:47:42.156884Z 0 [ERROR] [MY-010095] [Server] Failed to access directory for --secure-file-priv. Please make sure that directory exists and is accessible by MySQL Server. Supplied value : /var/lib/mysql-files\nstyle-ma-db | 2021-01-11T06:47:42.156895Z 0 [ERROR] [MY-010119] [Server] Aborting\n")])])]),a("p",[s._v("配置文件挂载错了")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("- /opt/mysql/my.conf:/etc/mysql/my.conf\n")])])]),a("p",[s._v("应改为:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("- /opt/mysql/my.cnf:/etc/mysql/my.cnf\n")])])]),a("h3",{attrs:{id:"启动容器后-无法登录mysql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动容器后-无法登录mysql"}},[s._v("#")]),s._v(" 启动容器后，无法登录mysql")]),s._v(" "),a("p",[s._v("docker-compose配置如下:")]),s._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mysql")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ma"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mysql\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("authentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plugin=mysql_native_password\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 3306"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /opt/mysql/data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/lib/mysql\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /opt/mysql/logs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/log/mysql\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /opt/mysql/my.cnf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/mysql/my.cnf\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /opt/mysql/conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/mysql\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" backend\n")])])]),a("p",[s._v("这里设置了"),a("code",[s._v("MYSQL_ROOT_PASSWORD")]),s._v("，然而 "),a("code",[s._v("mysql -u root -p")]),s._v("使用root却无法登录。")]),s._v(" "),a("h4",{attrs:{id:"问题出现原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题出现原因"}},[s._v("#")]),s._v(" 问题出现原因")]),s._v(" "),a("p",[s._v("The image "),a("code",[s._v("entrypoint")]),s._v(" script will never make changes to a "),a("code",[s._v("database")]),s._v(" which is existing. If you mount an existing data directory into "),a("code",[s._v("var/lib/mysql")]),s._v(" then "),a("code",[s._v("MYSQL_ROOT_PASSWORD")]),s._v(" will have no effect.")]),s._v(" "),a("h4",{attrs:{id:"解决方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方法"}},[s._v("#")]),s._v(" 解决方法")]),s._v(" "),a("p",[s._v("第一步：找出容器volume名称")]),s._v(" "),a("p",[s._v("你手动设置了volume名称，可以用"),a("code",[s._v("docker volume ls")]),s._v("查看；")]),s._v(" "),a("p",[s._v("如果没有手动设置，那么可以使用"),a("code",[s._v("docker insepect <mysql_container>")]),s._v("命令 查看")]),s._v(" "),a("p",[s._v("第二步：删除该volume")]),s._v(" "),a("p",[a("code",[s._v("docker volume rm <volume_name>")])]),s._v(" "),a("p",[s._v("已经删除了volume，再次启动容器，进入容器后，输入"),a("code",[s._v("mysql -u root -p")])]),s._v(" "),a("p",[s._v("输入密码，还是无法访问")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(" Access denied for user 'root'@'localhost' (using password: YES)\n")])])]),a("p",[s._v("参考了这个回答，与上面的思路一致，没有什么帮助。https://stackoverflow.com/questions/59838692/mysql-root-password-is-set-but-getting-access-denied-for-user-rootlocalhost")]),s._v(" "),a("p",[s._v("到目前已经确认不是volumes缓存的问题。")]),s._v(" "),a("p",[s._v("最终找到问题处在默认要执行的sql上，默认要执行的sql中创建了多余的系统数据库和表，可能是这些多余的数据库和表造成的问题。在sql中删除这些默认的数据库和表后，问题解决。")]),s._v(" "),a("h3",{attrs:{id:"docker-compose-down-或-docker-compose-stop后-再此启动-则无法访问-message-from-server-host-192-168-224-4-is-not-allowed-to-connect-to-this-mysql-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-down-或-docker-compose-stop后-再此启动-则无法访问-message-from-server-host-192-168-224-4-is-not-allowed-to-connect-to-this-mysql-server"}},[s._v("#")]),s._v(" docker-compose down 或 docker-compose stop后，再此启动，则无法访问“message from server: \"Host '192.168.224.4' is not allowed to connect to this MySQL server\"“")]),s._v(" "),a("p",[s._v("docker-compose down 会移除容器，但是不会移除volumes。")]),s._v(" "),a("p",[s._v("docker-compose stop 不会移除容器，也不会移除volumes。")]),s._v(" "),a("h3",{attrs:{id:"如何在启动mysql时-自动导入数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何在启动mysql时-自动导入数据库"}},[s._v("#")]),s._v(" 如何在启动mysql时，自动导入数据库")]),s._v(" "),a("h4",{attrs:{id:"initializing-a-fresh-instance"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#initializing-a-fresh-instance"}},[s._v("#")]),s._v(" Initializing a fresh instance")]),s._v(" "),a("p",[s._v("When a container is started for the first time, a new database with the specified name will be created and initialized with the provided configuration variables. Furthermore, it will execute files with extensions "),a("code",[s._v(".sh")]),s._v(", "),a("code",[s._v(".sql")]),s._v(" and "),a("code",[s._v(".sql.gz")]),s._v(" that are found in "),a("code",[s._v("/docker-entrypoint-initdb.d")]),s._v(". Files will be executed in alphabetical order. You can easily populate your "),a("code",[s._v("mysql")]),s._v(" services by "),a("a",{attrs:{href:"https://docs.docker.com/engine/tutorials/dockervolumes/#mount-a-host-file-as-a-data-volume",target:"_blank",rel:"noopener noreferrer"}},[s._v("mounting a SQL dump into that directory"),a("OutboundLink")],1),s._v(" and provide "),a("a",{attrs:{href:"https://docs.docker.com/reference/builder/",target:"_blank",rel:"noopener noreferrer"}},[s._v("custom images"),a("OutboundLink")],1),s._v(" with contributed data. SQL files will be imported by default to the database specified by the "),a("code",[s._v("MYSQL_DATABASE")]),s._v(" variable.")]),s._v(" "),a("p",[s._v("将sql文件挂载到容器的"),a("code",[s._v("/docker-entrypoint-initdb.d")]),s._v("目录下，然后设置环境变量"),a("code",[s._v("MYSQL_DATABASE")]),s._v("的值。")]),s._v(" "),a("h3",{attrs:{id:"存在远程访问权限的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存在远程访问权限的问题"}},[s._v("#")]),s._v(" 存在远程访问权限的问题:")]),s._v(" "),a("p",[s._v("mysql 默认只能本机登录，使用 "),a("code",[s._v("MYSQL_ROOT_HOST")]),s._v("环境变量 ，将其值修改为 "),a("code",[s._v("MYSQL_ROOT_HOST: '%'")])])])}),[],!1,null,null,null);t.default=r.exports}}]);